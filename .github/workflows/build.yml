name: ESP32-S3 Auto BIN Builder

on:
Â  push:
Â  workflow_dispatch:

jobs:
Â  build:
Â  Â  runs-on: ubuntu-latest

Â  Â  steps:

Â  Â  - name: Checkout repo
Â  Â  Â  uses: actions/checkout@v4

Â  Â  - name: Install Arduino CLI
Â  Â  Â  run: |
Â  Â  Â  Â  curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
Â  Â  Â  Â  sudo mv ./bin/arduino-cli /usr/local/bin/

Â  Â  - name: Configure Arduino
Â  Â  Â  run: |
Â  Â  Â  Â  arduino-cli config init
Â  Â  Â  Â  arduino-cli core update-index
Â  Â  Â  Â  arduino-cli core install esp32:esp32

Â  Â  ####################################################
Â  Â  #  AUTO-DETECT & INSTALL LIBRARIES (FIXED VERSION)
Â  Â  ####################################################
Â  Â  - name: Auto-detect & install libraries
Â  Â  Â  run: |
Â  Â  Â  Â  echo "ğŸ” Scanning for librariesâ€¦"

Â  Â  Â  Â  # Extract include names â†’ clean â†’ keep full names together
Â  Â  Â  Â  grep -hR '^#include' *.ino \
Â  Â  Â  Â  | sed 's/#include//; s/[<>""]//g' \
Â  Â  Â  Â  | sed 's/\.h$//' \
Â  Â  Â  Â  | sed 's/_/ /g' \
Â  Â  Â  Â  | sort -u > includes.txt || true

Â  Â  Â  Â  echo "ğŸ“„ Normalized libraries detected:"
Â  Â  Â  Â  cat includes.txt || true
Â  Â  Â  Â  echo

Â  Â  Â  Â  while read lib; do
Â  Â  Â  Â  Â  [ -z "$lib" ] && continue
Â  Â  Â  Â  Â  echo "ğŸ“¦ Installing â†’ $lib"
Â  Â  Â  Â  Â  arduino-cli lib install "$lib" || true
Â  Â  Â  Â  done < includes.txt

Â  Â  ####################################################
Â  Â  #  COMPILE FIRMWARE (USB-CDC ENABLED)
Â  Â  ####################################################
Â  Â  - name: Compile firmware
Â  Â  Â  run: |
Â  Â  Â  Â  arduino-cli compile \
Â  Â  Â  Â  Â  --fqbn esp32:esp32:esp32s3 \
Â  Â  Â  Â  Â  --build-property build.cdc_on_boot=1 \
Â  Â  Â  Â  Â  --build-property build.tinyusb_cdc_enabled=1 \
Â  Â  Â  Â  Â  --output-dir build .

Â  Â  ####################################################
Â  Â  #  PACKAGE & UPLOAD BIN FILES
Â  Â  ####################################################
Â  Â  - name: Package firmware
Â  Â  Â  run: zip -j esp32s3-firmware.zip build/*

Â  Â  - name: Upload firmware
Â  Â  Â  uses: actions/upload-artifact@v4
Â  Â  Â  with:
Â  Â  Â  Â  name: esp32s3-firmware
Â  Â  Â  Â  path: esp32s3-firmware.zip
