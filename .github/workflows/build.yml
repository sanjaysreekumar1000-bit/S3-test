name: ESP32-S3 Auto BIN Builder

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    # Get repo
    - name: Checkout repo
      uses: actions/checkout@v4

    # Install Arduino CLI
    - name: Install Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        sudo mv ./bin/arduino-cli /usr/local/bin/

    # Install ESP32 core
    - name: Configure Arduino
      run: |
        arduino-cli config init
        arduino-cli core update-index
        arduino-cli core install esp32:esp32


    ####################################################
    # AUTO-DETECT & NORMALIZE LIBRARIES (Verbose)
    ####################################################
    - name: Auto-detect & install libraries
      run: |
        echo "ðŸ”Ž Scanning for libraries..."

        # Read all #include headers â†’ clean â†’ normalize
        grep -hR '^#include' *.ino \
        | sed 's/#include[ <"]//; s/[>"].*//' \
        | sed 's/\.h$//' \
        | sort -u > includes_raw.txt || true

        echo ""
        echo "ðŸ“„ Detected headers:"
        cat includes_raw.txt || true
        echo ""

        while read raw; do
          [ -z "$raw" ] && continue

          echo "ðŸ§© Header found: $raw"

          # Convert underscores â†’ spaces
          norm=$(echo "$raw" | sed 's/_/ /g')

          echo "âž¡ Normalized name: $norm"

          echo "ðŸ“¦ Installing library â†’ $norm"
          if arduino-cli lib install "$norm"; then
            echo "âœ… Installed successfully"
          else
            echo "âš  Install failed â€” continuing anyway"
          fi
          echo ""

        done < includes_raw.txt


    ####################################################
    # COMPILE ESP32-S3 (USB-CDC ENABLED BIN)
    ####################################################
    - name: Compile firmware
      run: |
        arduino-cli compile \
          --fqbn esp32:esp32:esp32s3 \
          --build-property build.cdc_on_boot=1 \
          --build-property build.tinyusb_cdc_enabled=1 \
          --output-dir build .


    ####################################################
    # PACKAGE + UPLOAD BIN
    ####################################################
    - name: Package firmware
      run: zip -j esp32s3-firmware.zip build/*

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: esp32s3-firmware
        path: esp32s3-firmware.zip
