name: ESP32-S3 Auto BIN Builder

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        sudo mv ./bin/arduino-cli /usr/local/bin/

    - name: Configure Arduino
      run: |
        arduino-cli config init
        arduino-cli core update-index
        arduino-cli core install esp32:esp32

    ####################################################
    # AUTO-DETECT & INSTALL LIBRARIES (VERBOSE LOGGING)
    ####################################################
    - name: Auto-detect & install libraries (Verbose)
      run: |
        echo "üîç Scanning for libraries‚Ä¶"

        # Extract #include lines ‚Üí strip symbols ‚Üí remove .h ‚Üí dedupe
        grep -hR '^#include' *.ino \
        | sed 's/#include[ <"]//; s/[>"].*//' \
        | sed 's/\.h$//' \
        | sort -u > includes.txt || true

        echo
        echo "üìÑ Detected headers:"
        cat includes.txt || true
        echo

        while read lib; do
          [ -z "$lib" ] && continue

          echo "----------------------------------------"
          echo "üß© Header: $lib"

          # 1Ô∏è‚É£ Try exact library name
          echo "‚û° Trying exact: $lib"
          if arduino-cli lib install "$lib"; then
            echo "‚úÖ Installed: $lib"
            continue
          else
            echo "‚ùå Exact match failed"
          fi

          # 2Ô∏è‚É£ Try replacing _ with spaces
          spaced=$(echo "$lib" | sed 's/_/ /g')
          if [ "$spaced" != "$lib" ]; then
            echo "‚û° Trying spaced name: $spaced"
            if arduino-cli lib install "$spaced"; then
              echo "‚úÖ Installed: $spaced"
              continue
            else
              echo "‚ùå Spaced attempt failed"
            fi
          fi

          # 3Ô∏è‚É£ Search Arduino library index for closest match
          echo "‚û° Searching library index for: $lib"
          match=$(arduino-cli lib search "$lib" | awk 'NR==2{print $1}')

          if [ -n "$match" ]; then
            echo "üîé Match found ‚Üí $match"
            if arduino-cli lib install "$match"; then
              echo "‚úÖ Installed (resolved): $match"
            else
              echo "‚ö† Install failed but continuing"
            fi
          else
            echo "‚ö† No package found for: $lib"
          fi

        done < includes.txt

        echo
        echo "üéâ Library scan completed"

    ####################################################
    # COMPILE ESP32-S3 (USB CDC ENABLED)
    ####################################################
    - name: Compile firmware
      run: |
        arduino-cli compile \
          --fqbn esp32:esp32:esp32s3 \
          --build-property build.cdc_on_boot=1 \
          --build-property build.tinyusb_cdc_enabled=1 \
          --output-dir build .

    ####################################################
    # PACKAGE BIN FILES
    ####################################################
    - name: Package firmware
      run: zip -j esp32s3-firmware.zip build/*

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: esp32s3-firmware
        path: esp32s3-firmware.zip
